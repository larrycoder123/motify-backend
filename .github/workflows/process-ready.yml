name: Process ready challenges

on:
  schedule:
    - cron: '0 * * * *' # every hour
  workflow_dispatch: {}

concurrency:
  group: motify-process-ready
  cancel-in-progress: false

jobs:
  process-ready:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    env:
      # Non-secret: table/column names used to look up per-user provider tokens in Supabase
      USER_TOKENS_TABLE: user_tokens
      USER_TOKENS_WALLET_COL: wallet_address
      USER_TOKENS_PROVIDER_COL: provider
      USER_TOKENS_ACCESS_TOKEN_COL: access_token
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: "Preflight: token lookup config"
        run: |
          echo "USER_TOKENS_TABLE=${USER_TOKENS_TABLE}"
          echo "USER_TOKENS_WALLET_COL=${USER_TOKENS_WALLET_COL}"
          echo "USER_TOKENS_PROVIDER_COL=${USER_TOKENS_PROVIDER_COL}"
          echo "USER_TOKENS_ACCESS_TOKEN_COL=${USER_TOKENS_ACCESS_TOKEN_COL}"

      - name: Process ready challenges
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          WEB3_RPC_URL: ${{ secrets.WEB3_RPC_URL }}
          MOTIFY_CONTRACT_ADDRESS: ${{ secrets.MOTIFY_CONTRACT_ADDRESS }}
          MOTIFY_CONTRACT_ABI_PATH: ${{ secrets.MOTIFY_CONTRACT_ABI_PATH }}
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
          MAX_FEE_GWEI: ${{ secrets.MAX_FEE_GWEI }}
          STAKE_TOKEN_DECIMALS: ${{ secrets.STAKE_TOKEN_DECIMALS }}
          NEYNAR_API_KEY: ${{ secrets.NEYNAR_API_KEY }}
          # Optional controls (set these secrets if you want to override the defaults)
          DEFAULT_PERCENT_PPM: ${{ secrets.DEFAULT_PERCENT_PPM }}
          CHUNK_SIZE: ${{ secrets.CHUNK_SIZE }}
          SEND_TX: ${{ secrets.SEND_TX }}
        run: |
          set -e
          set -o pipefail
          python -m app.jobs.process_ready_all 2>&1 | tee process_ready_output.log

      - name: Upload run log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: process-ready-log
          path: process_ready_output.log
          retention-days: 14
